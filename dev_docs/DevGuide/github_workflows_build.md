# GitHub Actions Build & Release Workflow (build.yml)

This guide explains how to use the GitHub Actions workflow in `.github/workflows/build.yml` to build MuscleX installers and create a draft GitHub Release.

## Table of Contents
- [What this workflow does](#what-this-workflow-does)
- [How it is triggered](#how-it-is-triggered)
- [Outputs (artifacts)](#outputs-artifacts)
- [Recommended release flow](#recommended-release-flow)
- [Manual runs (workflow_dispatch)](#manual-runs-workflow_dispatch)
- [Versioning and tag rules](#versioning-and-tag-rules)
- [Troubleshooting](#troubleshooting)
- [Notes / future improvements](#notes--future-improvements)

---

## What this workflow does

The workflow `.github/workflows/build.yml` defines 3 build jobs and 1 release job:

- **Linux build (`build-linux`)**
  - Uses Ubuntu 22.04 + Python 3.10
  - Builds a PyInstaller distribution using `musclex_linux.spec`
  - Creates a **.deb** using `dev_docs/linux/make_deb_installer.py`
  - Builds a **source distribution** via `python setup.py sdist`
  - Uploads build artifacts as `musclex-linux`

- **Windows build (`build-windows`)**
  - Uses Windows Server 2022 + Python 3.10
  - Builds a PyInstaller distribution using `musclex_win32.spec`
  - Installs Inno Setup and produces a **Windows installer** (`*-Windows-Setup.exe`)
  - Uploads build artifacts as `musclex-windows`

- **macOS build (`build-macos`)**
  - **Currently disabled** via `if: false`
  - When enabled, it builds a DMG for both Apple Silicon and Intel

- **Release creation (`create-release`)**
  - Runs only for **tag pushes** (not manual runs)
  - Downloads artifacts from Linux + Windows jobs
  - Deletes any existing GitHub Release with the same tag name (best-effort)
  - Creates a **draft** GitHub Release and attaches artifacts
  - Marks prerelease automatically if tag contains `beta`, `alpha`, or `rc`

---

## How it is triggered

The workflow runs in two ways:

1. **Tag push**: any tag matching `v*` (example: `v1.26.0`)
2. **Manual trigger**: GitHub UI → Actions → “Build MuscleX” → “Run workflow”

Important behavior:
- A **tag push** runs builds and then the **draft Release** job.
- A **manual run** runs builds **only** (no release job), because `create-release` has:
  - `if: startsWith(github.ref, 'refs/tags/')`

---

## Outputs (artifacts)

The workflow uploads artifacts to the workflow run:

- **Linux artifact bundle (`musclex-linux`)**
  - `dist/*.deb`
  - `dist/*.tar.gz` (source distribution)

- **Windows artifact bundle (`musclex-windows`)**
  - `dist/musclex-*-Windows-Setup.exe`

Notes:
- Linux `.deb` is created in `dev_docs/linux/` and then moved into `dist/`.
- Before building the source distribution, the workflow deletes old `dist/*.tar.gz` to avoid uploading stale archives.

---

## Recommended release flow

### 1) Update version in code
Ensure the version in the codebase is correct (typically `musclex/__init__.py` contains `__version__`).

The workflow uses the Python version value during packaging:
- Windows step reads version: `python -c "from musclex import __version__; print(__version__)"`
- Linux packaging script typically embeds the version into the `.deb` filename.

### 2) Create and push a version tag
Tag format must start with `v`.

Example:
- `v1.26.1`

Push the tag to GitHub (from a clean main branch state):
- `git tag v1.26.1`
- `git push origin v1.26.1`

### 3) Watch the workflow run
GitHub UI → Actions → “Build MuscleX” → open the tag run.

Expected jobs:
- `build-linux` ✅
- `build-windows` ✅
- `create-release` ✅
- (`build-macos` is currently skipped/disabled)

### 4) Finalize the draft GitHub Release
The workflow creates a **draft release** with attached artifacts:
- Linux `.deb`
- Linux `tar.gz` (sdist)
- Windows `Setup.exe`

Edit release notes, verify filenames, then publish.

---

## Manual runs (workflow_dispatch)

Use manual runs for “smoke testing” the build without creating a release.

GitHub UI:
- Actions → “Build MuscleX” → “Run workflow”

What you get:
- Artifacts attached to the workflow run (downloadable from the run summary)

What you *don’t* get:
- No GitHub Release is created (because the ref is not a tag)

---

## Versioning and tag rules

- **Tag trigger**: must match `v*` (e.g. `v1.26.0`)
- **Prerelease detection**: if tag name contains one of:
  - `alpha`, `beta`, `rc`
  - Example: `v1.27.0-rc1` will become a prerelease draft

Recommended convention:
- Stable: `vX.Y.Z`
- Pre-release: `vX.Y.Z-rcN` / `vX.Y.Z-betaN`

---

## Troubleshooting

### Linux job fails creating .deb
- The workflow installs: `fakeroot` and `lintian`
- The `.deb` must be generated by `dev_docs/linux/make_deb_installer.py`
- If the job errors with “No .deb file found!”, it means nothing matching `dev_docs/linux/*.deb` was produced.

### “pip install -r requirements” fails
- The workflow installs dependencies from the repo root file named `requirements`.
- If you rename/move dependency files, update `build.yml` accordingly.

### Release job fails deleting/creating a release
- `create-release` uses:
  - `gh release delete ...` (best-effort)
  - `softprops/action-gh-release@v1`
- Ensure the workflow has sufficient permissions (default `GITHUB_TOKEN` is used).

### macOS artifacts are missing
- macOS is currently disabled: `build-macos: if: false`
- To re-enable, change/remove that condition and confirm macOS runners are available/working.

---

## Notes / future improvements

- Add a `permissions:` block (e.g. `contents: write`) if repo settings require explicit permissions for release creation.
- Consider adding inputs for manual runs (like “build linux only”) if you want faster iteration.
- Re-enable macOS after stabilizing the DMG creation steps and runner selection.