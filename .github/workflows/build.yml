name: Build MuscleX

on:
  push:
    tags:
      - 'v*'  # Run on version tags like v1.26.0
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot lintian
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements
          pip install -e .
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --clean -y musclex_linux.spec
      
      - name: Create DEB package
        run: |
          cd dev_docs/linux
          python make_deb_installer.py
          echo "=== Files in dev_docs/linux after build ==="
          ls -lah
          echo "=== Looking for .deb files ==="
          find . -maxdepth 1 -name "*.deb"
          # Move the deb file to dist directory
          if find . -maxdepth 1 -name "*.deb" | grep -q .; then
            find . -maxdepth 1 -name "*.deb" -exec mv {} ../../dist/ \;
            echo "✅ DEB file moved to dist/"
          else
            echo "❌ No .deb file found!"
            exit 1
          fi
          cd ../..
          # Verify the deb file exists
          echo "=== Files in dist/ ==="
          ls -lh dist/*.deb
      
      - name: Create source distribution (tar.gz)
        run: |
          # Remove old tar.gz files to avoid uploading them
          rm -f dist/*.tar.gz
          # Create new source distribution
          python setup.py sdist
          echo "=== Source distribution created ==="
          ls -lh dist/*.tar.gz
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: musclex-linux
          path: |
            dist/*.deb
            dist/*.tar.gz

  build-macos:
    strategy:
      matrix:
        include:
          - runner: macos-latest
            arch: arm64
          - runner: macos-15-intel
            arch: x86_64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements
          pip install -e .
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --clean -y musclex_mac.spec
      
      - name: Post-build fixes
        run: |
          # Create pyFAI utils directory (needed for pyFAI to find resources)
          mkdir -p dist/musclex/pyFAI/utils
      
      - name: Create App Bundle
        run: |
          # Get version from Python
          VERSION=$(python -c "from musclex import __version__; print(__version__)")
          
          # Remove old app bundle if it exists
          rm -rf dist/musclex.app
          
          # Create App Bundle structure
          mkdir -p dist/musclex.app/Contents/MacOS
          mkdir -p dist/musclex.app/Contents/Resources
          
          # Copy executable files
          cp -r dist/musclex dist/musclex.app/Contents/MacOS/
          
          # Copy icon
          if [ -f dev_docs/linux/AppIcon.icns ]; then
            cp dev_docs/linux/AppIcon.icns dist/musclex.app/Contents/Resources/
          fi
          
          # Create Info.plist
          cat > dist/musclex.app/Contents/Info.plist <<'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple Computer//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict><key>CFBundleDisplayName</key>
              <string>MuscleX</string>
              <key>CFBundleName</key>
              <string>Muscle X</string>
              <key>CFBundleIdentifier</key>
              <string>musclex</string>
              <key>CFBundleExecutable</key>
              <string>musclex/musclex-launcher</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>VERSION_PLACEHOLDER</string>
              <key>LSBackgroundOnly</key>
              <string>0</string>
          </dict>
          </plist>
          PLIST
          
          # Update version in Info.plist
          sed -i '' "s/VERSION_PLACEHOLDER/${VERSION}/g" dist/musclex.app/Contents/Info.plist
          
          # Remove quarantine attributes
          xattr -cr dist/musclex.app || true
          
          # Give system time to finish processing
          sleep 1
      
      - name: Create DMG
        run: |
          VERSION=$(python -c "from musclex import __version__; print(__version__)")
          ARCH="${{ matrix.arch }}"
          
          # Clean up any previous DMG temp folder or mounted volumes
          rm -rf dist/dmg_temp
          hdiutil detach "/Volumes/MuscleX ${VERSION}" 2>/dev/null || true
          
          # Wait a bit for system to release resources
          sleep 2
          
          # Create temp folder and copy files
          mkdir -p dist/dmg_temp
          cp -r dist/musclex.app dist/dmg_temp/
          ln -s /Applications dist/dmg_temp/Applications
          
          # Sync to ensure all writes are complete
          sync
          
          # Create DMG
          hdiutil create -volname "MuscleX ${VERSION}" -srcfolder dist/dmg_temp -ov -format UDZO "dist/musclex-${VERSION}-macOS-${ARCH}.dmg"
          
          
          # Clean up
          rm -rf dist/dmg_temp
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: musclex-macos-${{ matrix.arch }}
          path: dist/musclex-*-macOS-*.dmg

  build-windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install -r requirements
          pip install -e .
      
      - name: Build with PyInstaller
        run: |
          pyinstaller --clean -y musclex_win32.spec
      
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
      
      - name: Update version in Inno Setup script
        run: |
          $version = python -c "from musclex import __version__; print(__version__)"
          (Get-Content musclex_installer.iss) -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"$version`"" | Set-Content musclex_installer.iss
      
      - name: Build Installer with Inno Setup
        run: |
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" musclex_installer.iss
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: musclex-windows
          path: dist/musclex-*-Windows-Setup.exe

  create-release:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: |
          echo "=== Artifacts directory structure ==="
          ls -R artifacts
          echo ""
          echo "=== Checking for expected files ==="
          find artifacts -name "*.deb" -o -name "*.tar.gz" -o -name "*.dmg" -o -name "*.exe"
      
      - name: Delete existing release (if exists)
        continue-on-error: true
        run: |
          gh release delete ${{ github.ref_name }} --yes || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/musclex-linux/*.deb
            artifacts/musclex-linux/*.tar.gz
            artifacts/musclex-macos-arm64/*.dmg
            artifacts/musclex-macos-x86_64/*.dmg
            artifacts/musclex-windows/*-Setup.exe
          draft: true
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}